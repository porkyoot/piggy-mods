name: Release

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project to release'
        required: true
        type: choice
        options:
          - piggy-lib
          - piggy-admin
          - piggy-build
          - piggy-inventory
      version:
        description: 'Version number (e.g., 1.2.3)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout Master Project
      uses: actions/checkout@v4
      with:
        repository: porkyoot/piggy-mods
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Checkout Submodule (Current)
      uses: actions/checkout@v4
      with:
        path: ${{ inputs.project }}
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Update versions
      run: |
        PROJECT="${{ inputs.project }}"
        VERSION="${{ inputs.version }}"
        
        # Update gradle.properties based on project
        if [ "$PROJECT" = "piggy-lib" ]; then
          sed -i "s/^lib_version=.*/lib_version=$VERSION/" gradle.properties
          
          # Update all READMEs with new piggy-lib dependency version
          sed -i "s|\*\*\[Piggy Lib\][^:]*: >=.*|\*\*[Piggy Lib](https://github.com/porkyoot/piggy-lib)\*\*: >=$VERSION|" piggy-admin/README.md
          sed -i "s|\*\*\[Piggy Lib\][^:]*: >=.*|\*\*[Piggy Lib](https://github.com/porkyoot/piggy-lib)\*\*: >=$VERSION|" piggy-build/README.md
          sed -i "s|\*\*\[Piggy Lib\][^:]*: >=.*|\*\*[Piggy Lib](https://github.com/porkyoot/piggy-lib)\*\*: >=$VERSION|" piggy-inventory/README.md
          
          # Update fabric.mod.json dependencies
          sed -i "s/\"piggy-lib\": \">=.*\"/\"piggy-lib\": \">=$VERSION\"/" piggy-admin/src/main/resources/fabric.mod.json
          sed -i "s/\"piggy-lib\": \">=.*\"/\"piggy-lib\": \">=$VERSION\"/" piggy-build/src/main/resources/fabric.mod.json
          sed -i "s/\"piggy-lib\": \">=.*\"/\"piggy-lib\": \">=$VERSION\"/" piggy-inventory/src/main/resources/fabric.mod.json
          
          # Also update gametest fabric.mod.json if they exist
          if [ -f "piggy-admin/src/gametest/resources/fabric.mod.json" ]; then
            sed -i "s/\"piggy-lib\": \">=.*\"/\"piggy-lib\": \">=$VERSION\"/" piggy-admin/src/gametest/resources/fabric.mod.json
          fi
          if [ -f "piggy-build/src/gametest/resources/fabric.mod.json" ]; then
            sed -i "s/\"piggy-lib\": \">=.*\"/\"piggy-lib\": \">=$VERSION\"/" piggy-build/src/gametest/resources/fabric.mod.json
          fi
          if [ -f "piggy-inventory/src/gametest/resources/fabric.mod.json" ]; then
            sed -i "s/\"piggy-lib\": \">=.*\"/\"piggy-lib\": \">=$VERSION\"/" piggy-inventory/src/gametest/resources/fabric.mod.json
          fi
          
        elif [ "$PROJECT" = "piggy-admin" ]; then
          sed -i "s/^admin_version=.*/admin_version=$VERSION/" gradle.properties
        elif [ "$PROJECT" = "piggy-build" ]; then
          sed -i "s/^build_version=.*/build_version=$VERSION/" gradle.properties
        elif [ "$PROJECT" = "piggy-inventory" ]; then
          sed -i "s/^inventory_version=.*/inventory_version=$VERSION/" gradle.properties
        fi
        
        echo "Updated versions for $PROJECT to $VERSION"
        
    - name: Commit changes
      run: |
        PROJECT="${{ inputs.project }}"
        VERSION="${{ inputs.version }}"
        
        git add .
        git commit -m "chore: bump $PROJECT to v$VERSION" || echo "No changes to commit"
        
    - name: Create and push tag
      run: |
        PROJECT="${{ inputs.project }}"
        VERSION="${{ inputs.version }}"
        TAG="${PROJECT}-v${VERSION}"
        
        git tag "$TAG"
        git push origin main
        git push origin "$TAG"
        
    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'microsoft'
        
    - name: Make Gradle Wrapper Executable
      run: chmod +x ./gradlew
      
    - name: Build project
      run: |
        PROJECT="${{ inputs.project }}"
        ./gradlew :$PROJECT:build
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ inputs.project }}-v${{ inputs.version }}
        name: ${{ inputs.project }} v${{ inputs.version }}
        files: ${{ inputs.project }}/build/libs/*.jar
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
